<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Smart Seed Scanner</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #f5f5f5;
    text-align: center;
}

header {
    background: #2b8a3e;
    color: white;
    padding: 15px;
    font-size: 22px;
    font-weight: bold;
}

#camera {
    width: 90%;
    margin-top: 15px;
    border-radius: 12px;
    background: black;
}

button {
    padding: 12px 20px;
    background: #2b8a3e;
    color: white;
    border: none;
    border-radius: 8px;
    margin: 10px;
    font-size: 17px;
}

select {
    padding: 10px;
    font-size: 16px;
    border-radius: 6px;
}

#colorDot {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    margin: auto;
    border: 4px solid black;
    margin-top: 15px;
}

#resultBox {
    padding: 15px;
    margin-top: 15px;
    background: white;
    border-radius: 12px;
    width: 90%;
    margin-left: auto;
    margin-right: auto;
    font-size: 18px;
    box-shadow: 0px 0px 8px #ccc;
}

#barOuter {
    width: 90%;
    height: 22px;
    background: #ddd;
    border-radius: 12px;
    margin: 20px auto;
}

#barInner {
    width: 0%;
    height: 100%;
    background: #2b8a3e;
    border-radius: 12px;
    transition: width 1s ease-in-out;
}
</style>
</head>

<body>

<header id="title">Smart Seed Scanner</header>

<select id="language" onchange="changeLanguage()">
<option value="en">English</option>
<option value="ml">Malayalam</option>
<option value="hi">Hindi</option>
</select>

<br>

<select id="seedType">
<option>Paddy</option>
<option>Wheat</option>
<option>Ragi</option>
<option>Green Gram</option>
<option>Black Gram</option>
<option>Bengal Gram</option>
<option>Maize</option>
<option>Coconut</option>
<option>Groundnut</option>
<option>Sesame</option>
<option>Mustard</option>
<option>Sorghum</option>
</select>

<br><br>

<video id="camera" autoplay playsinline></video>

<button onclick="startCamera()">Start Camera</button>
<button onclick="scanColor()">Scan Now</button>

<div id="colorDot"></div>

<div id="resultBox">
<span id="moistureStatus">Status: ---</span><br>
<span id="germRate">Germination: --- %</span>
</div>

<div id="barOuter"><div id="barInner"></div></div>

<script>
let video = document.getElementById("camera");
let bar = document.getElementById("barInner");
let dot = document.getElementById("colorDot");
let lang = "en";

// TTS Voice
function speak(text) {
    let msg = new SpeechSynthesisUtterance(text);
    msg.lang = lang === "ml" ? "ml-IN" : lang === "hi" ? "hi-IN" : "en-IN";
    speechSynthesis.speak(msg);
}

// Beep
function beep() {
    let ctx = new AudioContext();
    let osc = ctx.createOscillator();
    osc.frequency.value = 600;
    osc.connect(ctx.destination);
    osc.start();
    osc.stop(ctx.currentTime + 0.12);
}

// Rear camera
async function startCamera() {
    try {
        let stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: { exact: "environment" } }
        });
        video.srcObject = stream;
    } catch (e) {
        alert("Unable to open rear camera. Allow permissions.");
    }
}

// Convert RGB → HSL
function rgbToHsl(r, g, b) {
    r /= 255; g /= 255; b /= 255;

    let max = Math.max(r, g, b),
        min = Math.min(r, g, b);

    let h, s, l = (max + min) / 2;

    if (max === min) h = 0;
    else {
        let d = max - min;
        h = max === r ? ((g - b) / d) % 6 :
            max === g ? (b - r) / d + 2 :
            (r - g) / d + 4;
        h *= 60;
    }

    return h < 0 ? h + 360 : h;
}

// Scan color
function scanColor() {
    let canvas = document.createElement("canvas");
    let ctx = canvas.getContext("2d");

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    ctx.drawImage(video, 0, 0);
    let x = canvas.width / 2;
    let y = canvas.height / 2;
    let data = ctx.getImageData(x, y, 10, 10).data;

    let r = 0, g = 0, b = 0;
    for (let i = 0; i < data.length; i += 4) {
        r += data[i];
        g += data[i + 1];
        b += data[i + 2];
    }

    r /= 25; g /= 25; b /= 25;

    dot.style.background = `rgb(${r},${g},${b})`;

    let h = rgbToHsl(r, g, b);
    classify(h);
}

// CLASSIFICATION using correct color ranges
function classify(h) {
    let status = "";
    let germ = 0;

    // Purple / Violet → H = 260–300
    if (h >= 260 && h <= 300) {
        status = translate("dry");
        germ = 20;
    }

    // Pink / Light Red → H = 330–20
    else if ((h >= 330 && h <= 360) || (h >= 0 && h <= 20)) {
        status = translate("ideal");
        germ = 90;
    }

    // Blue / Green → H = 80–240
    else if (h >= 80 && h <= 240) {
        status = translate("wet");
        germ = 40;
    }

    // Fallback
    else {
        status = translate("ideal");
        germ = 50;
    }

    document.getElementById("moistureStatus").innerText = status;
    document.getElementById("germRate").innerText = translate("germ") + germ + "%";
    bar.style.width = germ + "%";

    beep();
    setTimeout(() => speak(status), 300);
}

// Translations
function translate(key) {
    const words = {
        en: {
            dry: "Too Dry - Low germination",
            ideal: "Ideal Moisture",
            wet: "Too Wet - Fungus Risk",
            germ: "Germination: "
        },
        ml: {
            dry: "വളരെ വരണ്ടത് - കുറവ് മുളപ്പിക്കൽ",
            ideal: "ശരിയായ ഈർപ്പം",
            wet: "വളരെ ഈർപ്പം - ഫംഗസ് അപകടം",
            germ: "മുളപ്പിക്കൽ: "
        },
        hi: {
            dry: "बहुत सूखा - कम अंकुरण",
            ideal: "सही नमी स्तर",
            wet: "बहुत गीला - फफूंदी का खतरा",
            germ: "अंकुरण: "
        }
    };
    return words[lang][key];
}

function changeLanguage() {
    lang = document.getElementById("language").value;
}
</script>

</body>
</html>